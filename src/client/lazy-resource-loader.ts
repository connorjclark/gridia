export const ImageResources = [
  {
    file: 'world/graphics/armor.png',
    width: 640,
    height: 2112,
  },
  {
    file: 'world/graphics/bonus.png',
    width: 640,
    height: 96,
  },
  {
    file: 'world/graphics/emoticons.png',
    width: 640,
    height: 224,
  },
  {
    file: 'world/graphics/fishing.png',
    width: 640,
    height: 160,
  },
  {
    file: 'world/graphics/general.png',
    width: 640,
    height: 576,
  },
  {
    file: 'world/graphics/insects.png',
    width: 640,
    height: 160,
  },
  {
    file: 'world/graphics/misc.png',
    width: 640,
    height: 192,
  },
  {
    file: 'world/graphics/potions.png',
    width: 640,
    height: 960,
  },
  {
    file: 'world/graphics/weapons.png',
    width: 640,
    height: 768,
  },
  {
    file: 'world/graphics/rpgwo-animations0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-animations1.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-arms0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-chest0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-floors0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-floors1.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-floors2.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-floors3.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-floors4.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-floors5.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-head0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-head1.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item1.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item10.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item11.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item12.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item13.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item14.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item15.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item16.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item17.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item18.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item19.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item2.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item20.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item21.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item22.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item23.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item24.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item25.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item26.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item3.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item4.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item5.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item6.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item7.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item8.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-item9.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-legs0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-player0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-player1.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-player2.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-player3.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-player4.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-player5.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-player6.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-player7.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-shield0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-templates0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-weapon0.png',
    width: 320,
    height: 320,
  },
  {
    file: 'world/graphics/rpgwo-weapon1.png',
    width: 320,
    height: 320,
  },
];

export const SfxResources: Record<string, string> = {
  beep: './world/sound/sfx/rpgwo/beep.WAV',
  blowarrow: './world/sound/sfx/rpgwo/BlowArrow.WAV',
  bombtiq: './world/sound/sfx/rpgwo/bombtiq.wav',
  bubble: './world/sound/sfx/rpgwo/bubble.wav',
  burning: './world/sound/sfx/rpgwo/burning.wav',
  caneswish: './world/sound/sfx/rpgwo/CaneSwish.wav',
  carpentryhammer: './world/sound/sfx/rpgwo/CarpentryHammer.wav',
  criket: './world/sound/sfx/rpgwo/criket.wav',
  crossbow: './world/sound/sfx/rpgwo/Crossbow.wav',
  diescream: './world/sound/sfx/rpgwo/diescream.wav',
  digi_plink: './world/sound/sfx/rcptones/digi_plink.wav',
  door: './world/sound/sfx/rpgwo/door.wav',
  fishing: './world/sound/sfx/rpgwo/fishing.wav',
  harry: './world/sound/sfx/rpgwo/harry.wav',
  havenmayor: './world/sound/sfx/rpgwo/havenmayor.wav',
  heal: './world/sound/sfx/ff6/heal.wav',
  magic: './world/sound/sfx/paid/magic.wav',
  move: './world/sound/sfx/paid/move.wav',
  hiccup: './world/sound/sfx/rpgwo/hiccup.wav',
  ice: './world/sound/sfx/rpgwo/ice.WAV',
  pop_drip: './world/sound/sfx/rcptones/pop_drip.wav',
  punch: './world/sound/sfx/rpgwo/punch.wav',
  roll: './world/sound/sfx/zelda/roll.wav',
  saw: './world/sound/sfx/rpgwo/Saw.wav',
  shoveldig: './world/sound/sfx/rpgwo/ShovelDig.wav',
  smithinghammer: './world/sound/sfx/rpgwo/smithinghammer.wav',
  sparkly: './world/sound/sfx/rpgwo/sparkly.wav',
  warp: './world/sound/sfx/rpgwo/warp.wav',
  woodcutting: './world/sound/sfx/ryanconway/woodcutting.wav',
};

export function getMusicResource(name: string) {
  return `./world/sound/music/${name}`;
}

function createPromiseAndResolve() {
  let resolve: Function;
  const promise = new Promise<void>((r) => resolve = r);
  return {
    promise,
    // @ts-ignore
    resolve,
  };
}

class LazyResourceLoader {
  private loadQueue: string[] = [];
  private loadingResourcePromise = new Map<string, { promise: Promise<void>; resolve: Function }>();
  private isResourceLoaded = new Set<string>();

  hasResourceLoaded(key: string) {
    return this.isResourceLoaded.has(key);
    // The below doesn't work well - sometimes results in textures never showing. idk why
    // return loader.resources[key] && loader.resources[key].isComplete && loader.resources[key].texture;
  }

  loadResource(key: string) {
    let promiseAndResolve = this.loadingResourcePromise.get(key);
    if (promiseAndResolve) return promiseAndResolve.promise;

    promiseAndResolve = createPromiseAndResolve();
    this.loadingResourcePromise.set(key, promiseAndResolve);
    this.loadQueue.push(key);
    setInterval(this.processLoadQueue.bind(this), 1);
    return promiseAndResolve.promise;
  }

  loadAllImageResources() {
    const keys = [];
    for (const res of ImageResources) {
      if (this.isResourceLoaded.has(res.file)) continue;
      keys.push(res.file);
    }
    return Promise.all(keys.map((file) => this.loadResource(file)));
  }

  private processLoadQueue() {
    if (!this.loadQueue.length) return;
    if (PIXI.Loader.shared.loading) return;

    const queue = [...this.loadQueue];
    this.loadQueue.splice(0, this.loadQueue.length);

    PIXI.Loader.shared.add(queue).load((_, resources: PIXI.ILoaderResource[]) => {
      for (const resource of Object.values(resources)) {
        if (!resource) continue;

        const resolve = this.loadingResourcePromise.get(resource.name)?.resolve;
        if (resolve) {
          this.loadingResourcePromise.delete(resource.name);
          this.isResourceLoaded.add(resource.name);
          resolve();
        }
      }
      this.processLoadQueue();
    });
  }
}

export default LazyResourceLoader;
